<html>
    <head>
    <meta charset="UTF-8"/>
        <title>Dessin SVG avec d3.js</title>
        <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
    </head>
    <body>
        <svg xmlns="http://www.w3.org/2000/svg" id="dessin"></svg>

        <script type="module">

            // voir https://stackoverflow.com/a/65056488 (append if not exist)
            d3.selection.prototype.appendIfAbsent = function(selector, type) {
                const element = this.select(selector)
                return element.empty() ? this.append(type) : element
            }

            function rangeInt(n) {
                return Array.from({length: n + 1}, (_, i) => i);
            }

            function PartitionFloue(trapezes) {
                const svg = d3.select("#dessin");
                const width = 600;
                const height = width / 4;
                const margin = {top: 20, right: 10, bottom: 20, left: 10};
                const N = trapezes.length;

                svg.attr("viewBox", `0 0 ${width} ${height}`);

                const fX = d3.scaleLinear()
                    .domain([trapezes[0].supL - 1, trapezes[N-1].supH + 1])
                    .range([margin.left, width - margin.right]);

                const fY = d3.scaleLinear()
                    .domain([0, 1])
                    .range([height - margin.bottom, margin.top]);

                const fColor = d3.scaleOrdinal()
                    .domain(rangeInt(N))
                    .range(d3.schemeSet2);


                const bottom = fY(0);
                const top = fY(1);

                // Axe en bas
                svg.append("g")
                    .attr("transform", `translate(0, ${bottom})`)
                    .call(d3.axisBottom(fX));

                // Axe en haut
                svg.append("g")
                    .attr("transform", `translate(0, ${top})`)
                    .call(d3.axisTop(fX));
                
                // --- Groupe pour les trapèzes ---
                const grpTrapezes = svg.append("g");

                // Générer un <path> pour chaque trapèze
                grpTrapezes
                    .selectAll("g")  // ← Sélectionner des <g>, pas des <path>
                    .data(trapezes)
                    .join(
                        enter => {
                            const g = enter.append("g");
                            
                            g.append("path")
                                .attr("d", tr => {
                                    const points = [
                                        [fX(tr.corL), bottom],
                                        [fX(tr.corH), bottom],
                                        [fX(tr.supH), top],
                                        [fX(tr.supL), top]
                                    ];
                                    return points.map((p, i) => (i === 0 ? "M" : "L") + p.join(",")).join(" ") + " Z";
                                })
                                .attr("stroke", "red")
                                .attr("stroke-width", 2)
                                .attr("fill", tr => fColor(tr.id))
                                .attr("fill-opacity", 0.4);
                            
                            g.append("text")
                                .text(trp => trp.nom)
                                .attr("x", trp => fX((trp.supL + trp.supH) / 2))
                                .attr("y", (top + bottom) / 2);
                        }
                    )
            }


            const Trapezes = [
                { id: 0, supL: 5, corL: 11, corH: 14, supH: 18, nom: "froid" },
                { id: 1, supL: 14, corL: 18, corH: 20, supH: 22, nom: "frais" },
                { id: 2, supL: 20, corL: 22, corH: 24, supH: 30, nom: "tiède" },
                { id: 3, supL: 24, corL: 30, corH: 38, supH: 42, nom: "chaud" },
            ]

            d3.select("svg")
            .data([Trapezes])
            .each(function(d) {
                PartitionFloue(d);
            });
            

        </script>
    </body>
</html>